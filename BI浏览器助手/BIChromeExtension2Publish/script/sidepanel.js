let cachedCookies=null,lastCookieUpdateTime=0,currentPageType="none",version="1.0.0",tabId=null,bi_user_code=null,extension_debug_mode=!1,API_BASE_URL="http://datatool.gz.cvte.cn/api/bi-tools";async function getBICookies(){var e,t=Date.now();return(!cachedCookies||6e5<t-lastCookieUpdateTime)&&(e=await chrome.runtime.sendMessage({action:"getCookies"})).success&&(cachedCookies=e.cookies,lastCookieUpdateTime=t),cachedCookies}async function getUserCode(e){e=await fetch("https://bi.cvte.com/cbi/decision",{method:"GET",headers:{cookie:e}});if(!e.ok)throw new Error("获取用户信息时，请求失败! 请求状态码: "+e.status);var e=(await e.text()).match(/Dec\.personal\s*=\s*JSON\.parse\('([^']+)'\);/);e&&e[1]?(e=e[1].replace(/\\"/g,'"'),e=JSON.parse(e),console.log("user_name = "+e.username),bi_user_code=e.username):console.log("未找到 Dec.personal 的定义")}document.addEventListener("DOMContentLoaded",function(){initFunctionAreaToggle(),chrome.storage.local.get(["pageType","tabId"],e=>{initSidepanel(e.pageType),tabId=e.tabId}),getBICookies().then(e=>{getUserCode(e)}),GetVersion();let e=document.getElementById("debug-switch");e.checked=!1,e.addEventListener("change",function(){extension_debug_mode=e.checked,console.log("debug mode: "+extension_debug_mode)})}),chrome.runtime.onMessage.addListener((e,t,a)=>{"urlUpdated"===e.type&&e.pageType!=currentPageType&&tabId==e.tabId&&(currentPageType=e.pageType,initSidepanel(e.pageType))});let pageConfigurations={report:{name:"报表页面",groups:[{name:"信息查询",icon:"fa-search",functions:[{name:"基础信息",icon:"fa-info-circle",action:"getReportBasicInfo"},{name:"数据集信息",icon:"fa-database",action:"getReportDataInfo"},{name:"全屏查看",icon:"fa-link",action:"getReportExternalUrl"},{name:"报表简介",icon:"fa-book",action:"getReportDescription"},{name:"核心指标解读",icon:"fa-bug",action:"analyzeReportCoreMetric"}]},{name:"报表运维",icon:"fa-stethoscope",functions:[{name:"编辑报表",icon:"fa-edit",action:"getReportEditLink"},{name:"过滤器分析",icon:"fa-filter",action:"analyzeReportFilters"}]},{name:"权限查询",icon:"fa-lock",functions:[{name:"授权用户查询",icon:"fa-user-circle",action:"getReportAuthorizeUsers"},{name:"授权角色查询",icon:"fa-users",action:"getReportAuthorizeRoles"},{name:"授权部门查询",icon:"fa-institution",action:"getReportAuthorizeDepartments"},{name:"用户权限来源查询",icon:"fa-user-secret",action:"getUserReportAuthSource",input:{label:"用户域账号",placeholder:"多个账号用英文逗号分隔",required:!0,buttonText:"查询"}}]},{name:"权限操作",icon:"fa-cogs",functions:[{name:"给角色开通权限",icon:"fa-user-plus",action:"grantReportPermission",inputs:[{id:"report_grant_role",label:"待开通角色名称",placeholder:"多个角色用英文逗号分隔",required:!0},{id:"report_grant_type",label:"授权类型",placeholder:"查看/导出",required:!0}],buttonText:"开通权限"},{name:"关闭角色权限",icon:"fa-user-times",action:"revokeReportPermission",inputs:[{id:"report_revoke_role",label:"待关闭的角色名称",placeholder:"多个角色用英文逗号分隔",required:!0},{id:"report_revoke_type",label:"关闭权限类型",placeholder:"查看/导出",required:!0}],buttonText:"关闭权限"}]}]},analysis_folder:{name:"分析主题页面",groups:[{name:"信息查询",icon:"fa-search",functions:[{name:"发布仪表板搜索",icon:"fa-dashboard",action:"searchPublishedTemplate"},{name:"发布多次仪表板搜索",icon:"fa-th-large",action:"searchMultiPublishedTemplate"},{name:"问题仪表板搜索",icon:"fa-exclamation-circle",action:"searchErrorTemplate"},{name:"已协作的主题搜索",icon:"fa-share-alt",action:"searchCoeditSubject"},{name:"已分享的仪表板搜索",icon:"fa-share-square",action:"searchSharedTemplate"}]}]},config_folder:{name:"数据管理页面",groups:[{name:"信息查询",icon:"fa-search",functions:[{name:"未使用数据搜索",icon:"fa-ban",action:"getFolderUnusedData"},{name:"无发布报表数据搜索",icon:"fa-low-vision",action:"getFolderUnpublishedReportData"},{name:"占用空间数据搜索",icon:"fa-cubes",action:"getFolderLargeData"}]}]},config_table:{name:"数据管理页面",groups:[{name:"信息查询",icon:"fa-search",functions:[{name:"基础信息",icon:"fa-info-circle",action:"getDataBasicInfo"},{name:"下游发布报表详情",icon:"fa-dashboard",action:"getDataUsedPublishedTemplate"},{name:"下游未发布报表详情",icon:"fa-bar-chart",action:"getDataUsedUnpublishedTemplate"},{name:"引用数据详情",icon:"fa-database",action:"getDataUsedData"}]}]},analysis_subject_template:{name:"分析主题页面",groups:[{name:"信息查询",icon:"fa-search",functions:[{name:"发布信息查询",icon:"fa-dashboard",action:"getTemplatePublishInfo"},{name:"使用数据查询",icon:"fa-database",action:"getTemplateData"}]}]},subject_template_edit:{name:"报表编辑页面",groups:[{name:"信息查询",icon:"fa-tachometer-alt",functions:[{name:"使用数据查询",icon:"fa-database",action:"getSubjectEditTemplateData"},{name:"当前报表未使用组件",icon:"fa-bar-chart",action:"getSubjectEditNotUsedWidgets"},{name:"所有报表未使用组件",icon:"fa-barcode",action:"getSubjectEditAllNotUsedWidgets"}]},{name:"报表修改",icon:"fa-edit",functions:[{name:"数据集更名处理",icon:"fa-wrench",action:"processTemplateDataRename",inputs:[{id:"rename_data_id",label:"更名的数据集ID",placeholder:"更名的数据集ID",required:!0},{id:"rename_col_map",label:"字段更名映射",placeholder:"示例: {&quot;旧名称&quot;:&quot;新名称&quot;}",required:!0}],buttonText:"更名处理"},{name:"数据集替换处理",icon:"fa-retweet",action:"processTemplateDataReplace",inputs:[{id:"old_data_id",label:"旧数据集ID",placeholder:"数据集ID",required:!0},{id:"new_data_id",label:"新数据集ID",placeholder:"数据集ID",required:!0},{id:"replace_col_map",label:"字段名映射JSON(可选)",placeholder:"示例: {&quot;旧名称&quot;:&quot;新名称&quot;}",required:!1}],buttonText:"替换处理"}]}]},subject_widget:{name:"组件编辑页面",groups:[{name:"信息查询",icon:"fa-tachometer-alt",functions:[{name:"搜索错误指标",icon:"fa-times-circle",action:"getWidgetErrorMetric"},{name:"搜索无用指标",icon:"fa-bolt",action:"getWidgetNotusedMetric"},{name:"组件使用字段查询",icon:"fa-list-alt",action:"getWidgetUsedMeasure"},{name:"衍生指标解读",icon:"fa-eye",action:"analyzeWidgetAllMetric"}]},{name:"组件编辑",icon:"fa-edit",functions:[{name:"指标批量重命名",icon:"fa-reorder",action:"autoRenameMetricName"},{name:"指标过滤条件复制",icon:"fa-copy",action:"copyWidgetMeasureCondition",inputs:[{id:"widget_ref_metric",label:"参考指标名",placeholder:"已经设好条件的指标名",required:!0},{id:"widget_copy_metric",label:"待复制添加的指标名",placeholder:"多个用英文逗号分隔",required:!0}],buttonText:"复制"}]}]},management:{name:"系统管理页面",groups:[{name:"信息查询",icon:"fa-users-cog",functions:[{name:"查询用户拥有的角色",icon:"fa-drivers-license",action:"queryUserRole",input:{label:"用户域账号",placeholder:"多个账号用英文逗号分隔",required:!0,buttonText:"查询"}},{name:"查询角色包含的用户",icon:"fa-users",action:"queryRoleUser",input:{label:"角色名称",placeholder:"多角色用英文逗号隔开",required:!0,buttonText:"查询"}},{name:"可授权报表搜索",icon:"fa-search",action:"searchAuthReport",input:{label:"报表名称",placeholder:"报表名称",required:!0,buttonText:"查询"}}]},{name:"权限查询",icon:"fa-lock",functions:[{name:"查询用户拥有的报表权限",icon:"fa-dashboard",action:"queryUserReportAuth",input:{label:"用户域账号",placeholder:"单个用户",required:!0,buttonText:"查询"}},{name:"查询用户拥有的数据权限",icon:"fa-database",action:"queryUserDataAuth",input:{label:"用户域账号",placeholder:"单个用户",required:!0,buttonText:"查询"}},{name:"查询角色拥有的报表权限",icon:"fa-dashboard",action:"queryRoleReportAuth",input:{label:"角色名称",placeholder:"单个角色",required:!0,buttonText:"查询"}},{name:"查询角色拥有的数据权限",icon:"fa-database",action:"queryRoleDataAuth",input:{label:"角色名称",placeholder:"单个角色",required:!0,buttonText:"查询"}}]},{name:"权限操作",icon:"fa-cogs",functions:[{name:"开通角色报表权限",icon:"fa-dashboard",action:"grantRoleReportAuth",inputs:[{id:"grant_auth_roles",label:"角色名称",placeholder:"多个用英文逗号隔开",required:!0},{id:"grant_auth_reports",label:"报表ID",placeholder:"多个用英文逗号隔开",required:!0},{id:"grant_auth_type",label:"权限类型",placeholder:"查看/导出",required:!0}],buttonText:"开通权限"},{name:"关闭角色报表权限",icon:"fa-dashboard",action:"revokeRoleReportAuth",inputs:[{id:"revoke_auth_roles",label:"角色名称",placeholder:"多个用英文逗号隔开",required:!0},{id:"revoke_auth_reports",label:"报表ID",placeholder:"多个用英文逗号隔开",required:!0},{id:"revoke_auth_type",label:"权限类型",placeholder:"查看/导出",required:!0}],buttonText:"关闭权限"},{name:"关闭角色所有数据使用权限",icon:"fa-minus-square",action:"revokeRoleAllDataUse",input:{buttonText:"关闭权限",label:"角色名称",placeholder:"多个用英文逗号隔开",required:!0}}]}]},none:{name:"其他页面",groups:[{name:"该页面暂无可使用功能",icon:"fa-ban",functions:[]}]}};function initSidepanel(e){loadFunctionGroups(e),document.getElementById("clear-results").addEventListener("click",clearResults),initTabs(),updateStatusMessage("已加载配置: "+pageConfigurations[e].name)}function initFunctionAreaToggle(){let t=document.getElementById("toggle-function-area"),a=document.querySelector(".function-area");t.addEventListener("click",()=>{a.classList.toggle("expanded"),a.classList.toggle("collapsed");var e=t.querySelector("i");a.classList.contains("expanded")?(e.classList.replace("fa-chevron-down","fa-chevron-up"),t.setAttribute("title","折叠功能区"),updateStatusMessage("功能区已展开")):(e.classList.replace("fa-chevron-up","fa-chevron-down"),t.setAttribute("title","展开功能区"),updateStatusMessage("功能区已折叠"))})}function initTabs(){let a=document.querySelectorAll(".tab");a.forEach(t=>{t.addEventListener("click",()=>{a.forEach(e=>e.classList.remove("active")),t.classList.add("active");var e=t.getAttribute("data-tab");document.querySelectorAll(".tab-content").forEach(e=>{e.classList.remove("active")}),document.getElementById(e).classList.add("active"),"menu-operations"===e?updateStatusMessage("已加载配置: "+pageConfigurations[currentPageType].name):"chat-assistant"===e&&updateStatusMessage("聊天助手模式")})})}function updateStatusMessage(e){document.getElementById("status-message").textContent=e}function loadFunctionGroups(e){let o=document.getElementById("function-groups");o.innerHTML="";e=pageConfigurations[e];e&&(e.groups.forEach((e,t)=>{let a=document.createElement("div");a.className="function-group";var n=document.createElement("div");n.className="group-header",n.innerHTML=`
            <i class="fas ${e.icon}"></i>
            <span>${e.name}</span>
            <i class="fas fa-chevron-down toggle-icon"></i>
        `,n.addEventListener("click",()=>toggleGroup(a));let i=document.createElement("div");i.className="group-content",e.functions.forEach(r=>{if(r.inputs&&Array.isArray(r.inputs)){var e=document.createElement("div");e.className="function-with-input";let o="";r.inputs.forEach(e=>{var t=e.required?'<span class="required-mark">*</span>':"",a=e.required?"required":"",n=e.required?"multi-input required":"multi-input";o+=`
                        <div class="input-wrapper">
                            <label for="${r.action}-${e.id}" class="input-label">
                                ${e.label} ${t}
                            </label>
                            <input type="text" placeholder="${e.placeholder}" 
                                id="${r.action}-${e.id}" 
                                class="${n}" 
                                data-required="${e.required?"true":"false"}" 
                                ${a}>
                        </div>
                    `}),e.innerHTML=`
                    <div class="function-label">
                        <i class="fas ${r.icon}"></i>
                        <span>${r.name}</span>
                    </div>
                    <div class="multi-input-container">
                        ${o}
                        <button class="action-btn" data-action="${r.action}">
                            ${r.buttonText}
                        </button>
                    </div>
                `,i.appendChild(e)}else{var t,a,n;r.input?(e=r.input.required?'<span class="required-mark">*</span>':"",t=r.input.required?"required":"",a=r.input.required?"required input":"input",(n=document.createElement("div")).className="function-with-input",n.innerHTML=`
                    <div class="function-label">
                        <i class="fas ${r.icon}"></i>
                        <span>${r.name}</span>
                    </div>
                    <div class="input-container">
                        <div class="input-wrapper">
                            <label for="${r.action}-input" class="input-label">
                                ${r.input.label} ${e}
                            </label>
                            <input type="text" placeholder="${r.input.placeholder}" 
                                id="${r.action}-input" 
                                class="${a}" 
                                data-required="${r.input.required?"true":"false"}" 
                                ${t}>
                        </div>
                        <button class="action-btn" data-action="${r.action}">
                            ${r.input.buttonText}
                        </button>
                    </div>
                `,i.appendChild(n)):((e=document.createElement("button")).className="function-btn",e.setAttribute("data-action",r.action),e.innerHTML=`<i class="fas ${r.icon}"></i> `+r.name,i.appendChild(e))}}),a.appendChild(n),a.appendChild(i),o.appendChild(a)}),document.querySelectorAll(".function-btn, .action-btn").forEach(e=>{e.addEventListener("click",handleFunctionClick)}),document.querySelectorAll('input[data-required="true"]').forEach(t=>{t.addEventListener("blur",validateInput),t.addEventListener("input",()=>{t.classList.remove("input-error");var e=t.parentElement.querySelector(".error-message");e&&e.remove()})}))}function validateInput(e){var t,e=e.target;"true"===e.getAttribute("data-required")&&!e.value.trim()?(e.classList.add("input-error"),(t=e.parentElement.querySelector(".error-message"))||((t=document.createElement("div")).className="error-message",t.textContent="此字段为必填项",e.parentElement.appendChild(t))):(e.classList.remove("input-error"),(t=e.parentElement.querySelector(".error-message"))&&t.remove())}function toggleGroup(e){e.classList.toggle("expanded");var t=e.querySelector(".toggle-icon");e.classList.contains("expanded")?t.classList.replace("fa-chevron-down","fa-chevron-up"):t.classList.replace("fa-chevron-up","fa-chevron-down")}function showLoading(e="正在处理，请稍候..."){console.log("开始执行[showLoading]......");var t=document.getElementById("loading-overlay");document.getElementById("loading-text").textContent=e,t.classList.remove("hidden"),document.body.style.overflow="hidden"}function hideLoading(){console.log("开始执行[hideLoading]......"),document.getElementById("loading-overlay").classList.add("hidden"),document.body.style.overflow=""}async function getInforFromUrl(e){var t=await chrome.tabs.query({active:!0,currentWindow:!0});if(0===t.length)return addResultCard("获取标签页错误","无法获取当前标签页信息！请打开BI系统页面后再次尝试！","error"),null;var a=t[0].url;let n=null,o=null;switch(e){case"report":if(n=a.match(/activeTab=([^&]*)/),o=n?n[1]:null)break;return addResultCard("获取报表ID错误","未找到报表ID！请在报表页面上再次尝试！","error"),null;case"analysis_folder":if(n=a.match(/own\/folder\/([^&]*)/),o=n?n[1]:null)break;return addResultCard("获取分析主题目录ID错误","未找到分析主题目录ID！请在分析主题页面上再次尝试！","error"),null;case"analysis_subject_template":var r=(n=a.match(/analysis\/own\/subject\/([^\/]*)\/report\/([^&]*)/))?n[1]:null,i=n?n[2]:null;if(!i)return addResultCard("获取分析主题ID错误","未找到分析主题ID！请在分析主题页面上再次尝试！","error"),null;o=r+"_"+i;break;case"config_folder":if(n=a.match(/config\/folder\/([^&]*)/),o=n?n[1]:null)break;return addResultCard("获取分析数据目录ID错误","未找到分析主题目录ID！请在数据管理页面上再次尝试！","error"),null;case"config_table":if(n=a.match(/config\/table\/([^?]*)/),!(o=n?n[1]:null))return addResultCard("获取数据集ID错误","未找到数据集ID！请在数据管理页面上再次尝试！","error"),null;o=decodeURIComponent(o);break;case"subject_template_edit":r=(n=a.match(/subject\/page\/edit\/([^&]*)\/report\/([^&]*)/))?n[1]:null,i=n?n[2]:null;if(!r||!i)return addResultCard("获取分析主题ID错误","未找到分析主题ID！请在分析主题编辑页面上再次尝试！","error"),null;o=r+"_"+i;break;case"subject_widget":n=a.match(/subject\/page\/edit\/([^&]*)\/widget\/([^&]*)/),subject_id=n?n[1]:null;r=n?n[2]:null;if(!subject_id||!r)return addResultCard("获取分析主题ID错误","未找到分析主题ID！请在分析主题编辑页面上再次尝试！","error"),null;o=subject_id+"_"+r;break;case"management":o="default"}return o}async function GetVersion(){document.getElementById("status-version").innerText="版本:"+version;try{url=API_BASE_URL+"/version";var e,t=await fetch(url,{method:"GET",headers:{"Content-Type":"application/json"}});t.ok?(e=await t.json(),version!==e.version&&(document.getElementById("status-version").innerHTML=e.updateInfo)):console.error("获取版本时接口请求失败！详细信息："+t.text)}catch(e){console.error("获取版本时发生错误: "+e)}}async function FetchAPIResponse(e,t,a={}){t=await getInforFromUrl(t);if(console.log("key_id:"+t),t){var n=await getBICookies();try{var o,r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key_id:t,debug_mode:extension_debug_mode,cookie:n,user_code:bi_user_code,obj_data:a})});r.ok?("file_md5"in(o=await r.json())&&addResultCard("结果下载",`<a href="${`${API_BASE_URL}/download-file/${o.file_md5}?user_code=`+bi_user_code}" target="_blank">点我下载</a>结果明细文件。`,"success"),o.info_list.forEach(e=>{addResultCard(e[0],e[1],e[2])})):addResultCard("获取信息失败","请求API获取信息时失败！失败信息:<br/>"+await r.text(),"error")}catch(e){addResultCard("获取信息失败","请求API获取信息时出现错误！错误信息:<br/>"+e,"error")}}}function handleFunctionClick(e){let n=e.currentTarget.getAttribute("data-action"),t=(updateStatusMessage("正在执行: "+n),null),o={},r=!1;var a=["查看","导出"];if(Object.values(pageConfigurations).forEach(e=>{e.groups.forEach(e=>{e.functions.forEach(e=>{e.action===n&&(t=e)})})}),t&&t.inputs){if(t.inputs.forEach(e=>{var t,a=n+"-"+e.id,a=document.getElementById(a);a&&(t=a.value.trim(),o[e.id]=t,e.required)&&!t&&(a.classList.add("input-error"),(e=a.parentElement.querySelector(".error-message"))||((e=document.createElement("div")).className="error-message",e.textContent="此字段为必填项",a.parentElement.appendChild(e)),r=!0)}),r)return addResultCard("验证错误","请填写所有必填字段","error"),void updateStatusMessage("操作失败: 验证错误")}else if(t&&t.input){e=n+"-input",e=document.getElementById(e);if(e){var i=e.value.trim();if(o.input=i,t.input.required&&!i)return e.classList.add("input-error"),(i=e.parentElement.querySelector(".error-message"))||((i=document.createElement("div")).className="error-message",i.textContent="此字段为必填项",e.parentElement.appendChild(i)),addResultCard("验证错误","请填写必填字段","error"),void updateStatusMessage("操作失败: 验证错误")}}switch(n){case"getReportBasicInfo":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/report/basic-info","report").then(()=>{hideLoading()});break;case"getReportDataInfo":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/report/data-info","report").then(()=>{hideLoading()});break;case"getReportExternalUrl":FetchAPIResponse(API_BASE_URL+"/report/out-link","report");break;case"getReportDescription":showLoading("正在分析，请稍后..."),FetchAPIResponse(API_BASE_URL+"/report/description","report").then(()=>{hideLoading()});break;case"getReportEditLink":FetchAPIResponse(API_BASE_URL+"/report/edit-link","report");break;case"analyzeReportCoreMetric":showLoading("正在分析，请稍后..."),FetchAPIResponse(API_BASE_URL+"/report/analyze-core-metric","report").then(()=>{hideLoading()});break;case"analyzeReportFilters":showLoading("正在分析，请稍后..."),FetchAPIResponse(API_BASE_URL+"/report/analyze-filter","report").then(()=>{hideLoading()});break;case"getReportAuthorizeUsers":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/report/authorized-users","report").then(()=>{hideLoading()});break;case"getReportAuthorizeRoles":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/report/authorized-roles","report").then(()=>{hideLoading()});break;case"getReportAuthorizeDepartments":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/report/authorized-departments","report").then(()=>{hideLoading()});break;case"getUserReportAuthSource":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/report/user-auth-source","report",{user_codes:o.input}).then(()=>{hideLoading()});break;case"grantReportPermission":showLoading("正在开通，请稍后..."),a.includes(o.report_grant_type)?(s={grant_role:o.report_grant_role,grant_type:o.report_grant_type},FetchAPIResponse(API_BASE_URL+"/report/grant-role-auth","report",s).then(()=>{hideLoading()})):(addResultCard("信息错误","权限类型只能输入：查看 或者 导出。","error"),hideLoading());break;case"revokeReportPermission":showLoading("正在关闭，请稍后..."),a.includes(o.report_revoke_type)?(s={revoke_role:o.report_revoke_role,revoke_type:o.report_revoke_type},FetchAPIResponse(API_BASE_URL+"/report/revoke-role-auth","report",s).then(()=>{hideLoading()})):(addResultCard("信息错误","权限类型只能输入：查看 或者 导出。","error"),hideLoading());break;case"searchPublishedTemplate":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/analysis/search-published-template","analysis_folder").then(()=>{hideLoading()});break;case"searchMultiPublishedTemplate":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/analysis/search-multi-published-template","analysis_folder").then(()=>{hideLoading()});break;case"searchErrorTemplate":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/analysis/search-error-template","analysis_folder").then(()=>{hideLoading()});break;case"searchCoeditSubject":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/analysis/search-coedit-subject","analysis_folder").then(()=>{hideLoading()});break;case"searchSharedTemplate":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/analysis/search-shared-template","analysis_folder").then(()=>{hideLoading()});break;case"getTemplatePublishInfo":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/analysis/template-publish-info","analysis_subject_template").then(()=>{hideLoading()});break;case"getTemplateData":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/template/data-info","analysis_subject_template").then(()=>{hideLoading()});break;case"getFolderUnusedData":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/config/unused-data","config_folder").then(()=>{hideLoading()});break;case"getFolderUnpublishedReportData":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/config/unpublished-report-data","config_folder").then(()=>{hideLoading()});break;case"getFolderLargeData":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/config/large-data","config_folder").then(()=>{hideLoading()});break;case"getDataBasicInfo":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/data/basic-info","config_table").then(()=>{hideLoading()});break;case"getDataUsedPublishedTemplate":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/data/used-published-template","config_table").then(()=>{hideLoading()});break;case"getDataUsedUnpublishedTemplate":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/data/used-unpublished-template","config_table").then(()=>{hideLoading()});break;case"getDataUsedData":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/data/used-data","config_table").then(()=>{hideLoading()});break;case"getSubjectEditTemplateData":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/template/data-info","subject_template_edit").then(()=>{hideLoading()});break;case"getSubjectEditNotUsedWidgets":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/template/not-used-widgets","subject_template_edit").then(()=>{hideLoading()});break;case"getSubjectEditAllNotUsedWidgets":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/template/never-used-widgets","subject_template_edit").then(()=>{hideLoading()});break;case"processTemplateDataRename":try{JSON.parse(o.rename_col_map)}catch(e){return void addResultCard("信息错误","字段映射信息格式错误，请检查后重试。","error")}showLoading("正在处理，请稍后...");var s={data_id:o.rename_data_id,col_map:o.rename_col_map};FetchAPIResponse(API_BASE_URL+"/template/process-data-rename","subject_template_edit",s).then(()=>{hideLoading()});break;case"processTemplateDataReplace":if(console.log(o.replace_col_map),o.replace_col_map&&""!=o.replace_col_map)try{JSON.parse(o.replace_col_map)}catch(e){return void addResultCard("信息错误","字段映射信息格式错误，请检查后重试。","error")}showLoading("正在处理，请稍后...");var s={old_data_id:o.old_data_id,new_data_id:o.new_data_id,col_map:o.replace_col_map};FetchAPIResponse(API_BASE_URL+"/template/process-data-replace","subject_template_edit",s).then(()=>{hideLoading()});break;case"getWidgetErrorMetric":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/widget/error-metric","subject_widget").then(()=>{hideLoading()});break;case"getWidgetNotusedMetric":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/widget/never-used-metric","subject_widget").then(()=>{hideLoading()});break;case"getWidgetUsedMeasure":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/widget/used-measure","subject_widget").then(()=>{hideLoading()});break;case"analyzeWidgetAllMetric":showLoading("正在分析，请稍后..."),FetchAPIResponse(API_BASE_URL+"/widget/analyze-all-metric","subject_widget").then(()=>{hideLoading()});break;case"autoRenameMetricName":showLoading("正在处理，请稍后..."),FetchAPIResponse(API_BASE_URL+"/widget/auto-rename-metric","subject_widget").then(()=>{hideLoading()});break;case"copyWidgetMeasureCondition":showLoading("正在处理，请稍后...");var s={ref_metric:o.widget_ref_metric,copy_metric:o.widget_copy_metric};FetchAPIResponse(API_BASE_URL+"/widget/copy-metric-condition","subject_widget",s).then(()=>{hideLoading()});break;case"queryUserRole":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/management/query-user-role","management",{user_code:o.input}).then(()=>{hideLoading()});break;case"queryRoleUser":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/management/query-role-user","management",{role_name:o.input}).then(()=>{hideLoading()});break;case"searchAuthReport":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/management/search-auth-report","management",{report_name:o.input}).then(()=>{hideLoading()});break;case"queryUserReportAuth":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/management/query-user-report-auth","management",{user_code:o.input}).then(()=>{hideLoading()});break;case"queryUserDataAuth":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/management/query-user-data-auth","management",{user_code:o.input}).then(()=>{hideLoading()});break;case"queryRoleReportAuth":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/management/query-role-report-auth","management",{role_name:o.input}).then(()=>{hideLoading()});break;case"queryRoleDataAuth":showLoading("正在查询，请稍后..."),FetchAPIResponse(API_BASE_URL+"/management/query-role-data-auth","management",{role_name:o.input}).then(()=>{hideLoading()});break;case"grantRoleReportAuth":a.includes(o.grant_auth_type)?(showLoading("正在开通，请稍后..."),s={grant_roles:o.grant_auth_roles,grant_type:o.grant_auth_type,grant_reports:o.grant_auth_reports},FetchAPIResponse(API_BASE_URL+"/management/grant-role-report","management",s).then(()=>{hideLoading()})):addResultCard("信息错误","权限类型只能输入：查看 或者 导出。","error");break;case"revokeRoleReportAuth":a.includes(o.revoke_auth_type)?(showLoading("正在关闭，请稍后..."),s={revoke_roles:o.revoke_auth_roles,revoke_type:o.revoke_auth_type,revoke_reports:o.revoke_auth_reports},FetchAPIResponse(API_BASE_URL+"/management/revoke-role-report","management",s).then(()=>{hideLoading()})):addResultCard("信息错误","权限类型只能输入：查看 或者 导出。","error");break;case"revokeRoleAllDataUse":showLoading("正在关闭，请稍后..."),FetchAPIResponse(API_BASE_URL+"/management/revoke-role-all-data-use","management",{role_names:o.input}).then(()=>{hideLoading()});break;default:addResultCard("操作结果",`执行了 ${n} 操作`,"info")}setTimeout(()=>{updateStatusMessage("操作完成")},1e3),document.querySelector(".function-area").classList.contains("expanded")}function formatContentList(e){if(!Array.isArray(e))return e;let t="";for(var a of e)if(Array.isArray(a)){t+='<ul class="report-list">';for(var n of a)t+=`<li>${n}</li>`;t+="</ul>"}else t+=`<p>${a}</p>`;return t}function addResultCard(e,t,a="info"){var n=document.getElementById("result-cards");let o=document.createElement("div");o.className="result-card "+a;a=(new Date).toLocaleTimeString();o.innerHTML=`
        <div class="card-header">
            <h3>${e}</h3>
            <span class="timestamp">${a}</span>
            <button class="close-card"><i class="fas fa-times"></i></button>
        </div>
        <div class="card-content">${formatContentList(t)}</div>
    `,o.querySelector(".close-card").addEventListener("click",()=>{o.remove()}),n.appendChild(o)}function clearResults(){document.getElementById("result-cards").innerHTML="",updateStatusMessage("已清除所有结果")}function changePageType(e){pageConfigurations[e]&&(loadFunctionGroups(currentPageType=e),updateStatusMessage("已加载配置: "+pageConfigurations[e].name))}